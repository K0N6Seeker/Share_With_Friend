// à¸™à¸³à¹€à¸‚à¹‰à¸²à¹‚à¸¡à¸”à¸¹à¸¥ express à¹€à¸žà¸·à¹ˆà¸­à¸ªà¸£à¹‰à¸²à¸‡à¹à¸¥à¸°à¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ HTTP
const express = require('express');

// à¸™à¸³à¹€à¸‚à¹‰à¸²à¹‚à¸¡à¸”à¸¹à¸¥ createClient à¸ˆà¸²à¸ redis à¹€à¸žà¸·à¹ˆà¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸šà¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Redis
const { createClient } = require('redis');

// à¸™à¸³à¹€à¸‚à¹‰à¸²à¹‚à¸¡à¸”à¸¹à¸¥ noteRoutes à¸‹à¸¶à¹ˆà¸‡à¸à¸³à¸«à¸™à¸”à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸à¸²à¸£à¸ˆà¸±à¸”à¸à¸²à¸£à¸„à¸³à¸‚à¸­à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹‚à¸™à¹‰à¸•
const noteRoutes = require('./routes/noteRoutes');

// à¸™à¸³à¹€à¸‚à¹‰à¸²à¹‚à¸¡à¸”à¸¹à¸¥ path à¹€à¸žà¸·à¹ˆà¸­à¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¹ƒà¸™à¸£à¸°à¸šà¸š
const path = require('path');

// à¸ªà¸£à¹‰à¸²à¸‡à¸­à¸´à¸™à¸ªà¹à¸•à¸™à¸‹à¹Œà¸‚à¸­à¸‡à¹à¸­à¸›à¸žà¸¥à¸´à¹€à¸„à¸Šà¸±à¸™ Express
const app = express();

// à¸ªà¸£à¹‰à¸²à¸‡ Redis client à¹‚à¸”à¸¢à¸£à¸°à¸šà¸¸ URL à¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­
// URL 'redis://redis:6379' à¹ƒà¸Šà¹‰à¹‚à¸®à¸ªà¸•à¹Œ 'redis' à¹à¸¥à¸°à¸žà¸­à¸£à¹Œà¸• 6379
// à¸„à¹ˆà¸²à¸™à¸µà¹‰à¹€à¸«à¸¡à¸²à¸°à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¸ à¸²à¸žà¹à¸§à¸”à¸¥à¹‰à¸­à¸¡ Docker à¸—à¸µà¹ˆà¸Šà¸·à¹ˆà¸­à¹€à¸‹à¸­à¸£à¹Œà¸§à¸´à¸ª Redis à¸„à¸·à¸­ 'redis'
const redis = createClient({ url: 'redis://redis:6379' });

// à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸±à¸šà¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ Redis
redis.connect()
  .then(() => console.log('âœ… Connected to Redis')) // à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ
  .catch(err => console.error('âŒ Redis connection error:', err)); // à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸œà¸´à¸”à¸žà¸¥à¸²à¸”à¸«à¸²à¸à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§

// Middleware à¸ªà¸³à¸«à¸£à¸±à¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸Ÿà¸­à¸£à¹Œà¸¡à¹à¸¥à¸°à¹„à¸Ÿà¸¥à¹Œà¸ªà¹à¸•à¸•à¸´à¸
// express.urlencoded à¹ƒà¸Šà¹‰à¹€à¸žà¸·à¹ˆà¸­à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸à¸Ÿà¸­à¸£à¹Œà¸¡ HTML (à¹€à¸Šà¹ˆà¸™ POST) à¹€à¸›à¹‡à¸™à¸­à¹‡à¸­à¸šà¹€à¸ˆà¹‡à¸à¸•à¹Œ
app.use(express.urlencoded({ extended: true }));

// express.static à¹ƒà¸Šà¹‰à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰à¸šà¸£à¸´à¸à¸²à¸£à¹„à¸Ÿà¸¥à¹Œà¸ªà¹à¸•à¸•à¸´à¸ (à¹€à¸Šà¹ˆà¸™ CSS, JS, à¸£à¸¹à¸›à¸ à¸²à¸ž) à¸ˆà¸²à¸à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ 'public'
app.use(express.static(path.join(__dirname, 'public')));

// à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² view engine à¹€à¸›à¹‡à¸™ EJS à¹€à¸žà¸·à¹ˆà¸­à¹€à¸£à¸™à¹€à¸”à¸­à¸£à¹Œà¹€à¸—à¸¡à¹€à¸žà¸¥à¸• HTML à¹à¸šà¸šà¹„à¸”à¸™à¸²à¸¡à¸´à¸
app.set('view engine', 'ejs');

// à¸à¸³à¸«à¸™à¸”à¹‚à¸Ÿà¸¥à¹€à¸”à¸­à¸£à¹Œ 'view' à¹€à¸›à¹‡à¸™à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¹„à¸Ÿà¸¥à¹Œà¹€à¸—à¸¡à¹€à¸žà¸¥à¸• EJS
app.set('views', path.join(__dirname, 'view'));

// Middleware à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡ Redis client à¹„à¸›à¸¢à¸±à¸‡à¸—à¸¸à¸ route handler
// à¹€à¸žà¸´à¹ˆà¸¡ redis client à¹ƒà¸™ req.redis à¹€à¸žà¸·à¹ˆà¸­à¹ƒà¸«à¹‰ route handler à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¹„à¸”à¹‰
app.use((req, res, next) => {
  req.redis = redis;
  next(); // à¹€à¸£à¸µà¸¢à¸ middleware à¸«à¸£à¸·à¸­ handler à¸–à¸±à¸”à¹„à¸›
});

// à¹ƒà¸Šà¹‰ noteRoutes à¸ªà¸³à¸«à¸£à¸±à¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸”à¹‰à¸§à¸¢ '/'
app.use('/', noteRoutes);

// Middleware à¸ªà¸³à¸«à¸£à¸±à¸šà¸ˆà¸±à¸”à¸à¸²à¸£à¸„à¸³à¸‚à¸­à¸—à¸µà¹ˆà¹„à¸¡à¹ˆà¸žà¸šà¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡ (404)
app.use((req, res) => {
  res.status(404).send('Page not found'); // à¸ªà¹ˆà¸‡à¸ªà¸–à¸²à¸™à¸° 404 à¹à¸¥à¸°à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
});

// à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ
// à¸à¸³à¸«à¸™à¸”à¸žà¸­à¸£à¹Œà¸•à¹€à¸›à¹‡à¸™ 3000
const PORT = 3000;

// à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œà¹à¸¥à¸°à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸—à¸³à¸‡à¸²à¸™
app.listen(PORT, () => {
  console.log(`ðŸš€ Server is running at http://localhost:${PORT}`);
});